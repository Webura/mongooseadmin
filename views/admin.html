<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>{{title}}</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{path}}/bootstrap.min.css">
    <style>
        .table-hover td {
            cursor: pointer;
        }
    </style>
    {{css}}
</head>
<body>
<div class="container-fluid">
    <h1>{{title}}</h1>

    <ul id="models" class="nav nav-tabs nav-ta">
    </ul>

    <div class="row">
        <div id="rows" class="col-sm-6">
        </div>
        <form id="data" class="col-sm-6">

        </form>
    </div>
</div>

<script src="{{path}}/jquery.min.js"></script>
<script src="{{path}}/bootstrap.min.js"></script>
<script>
    var schemas;
    $(function () {
        $.get('{{path}}/models', function (data) {
            schemas = data;
            var models = '';
            for (var name in schemas) {
                models += '<li><a data-toggle="tab" href="#">' + name + '</a></li>'
            }
            $('#models')
                    .append(models)
                    .append('<li style="float:right"><a href="{{path}}/logout">Log out</a></li>')
                    .find('a').first().click();
        });
        function updateRows(modelName) {
            $.get('{{path}}/models/' + modelName, function (data) {
                var fields = data.fields;
                data = data.data;
                var rows = '<table data-id="' + modelName + '" class="table table-condensed table-hover"><thead><tr>';
                fields.forEach(function (field) {
                    rows += '<th>' + field.toUpperCase() + '</th>';
                });
                rows += '</tr></thead>';
                data.forEach(function (row) {
                    rows += '<tr data-id="' + row._id + '">';
                    fields.forEach(function (field) {
                        rows += '<td>' + row[field] + '</td>';
                    });
                    rows += '</tr>';
                });
                rows += '</table>';
                $('#rows').empty().append(rows).append('<button class="btn btn-primary" id="newRow">New row</button>');
            });
        }

        $('#models').on('click', 'a', function () {
            var modelName = $(this).text();
            if (modelName != 'Log out') {
                updateRows(modelName);
                $('#data').empty();
            }
        });

        $('#rows').on('click', 'tr', function () {
            var tr = $(this);
            if (tr.find('td').length > 0) {
                $.get('{{path}}/data/' + tr.closest('table').data('id') + '/' + tr.data('id'), function (data) {
                    var schema = schemas[tr.closest('table').data('id')];
                    var result = '';
                    for (var field in schema) {
                        if (field !== '__v') {
                            var value = data[field];
                            var info = ' - ' + schema[field].instance;
                            if (schema[field].instance == 'ObjectID' && schema[field].ref)
                                info = ' - ' + schema[field].ref + ' ObjectID';
                            if (schema[field].isRequired)
                                info += ', required';
                            var required = schema[field].isRequired ? 'required' : '';
                            var disabled = field == '_id' ? ' disabled ' : '';
                            var type = 'text';
                            if (schema[field].instance == 'Number')
                                type = 'number';
                            if (schema[field].instance == 'Boolean') {
                                value = value ? 'checked' : '';
                                result += '<div class="form-group"><label for="' + field + '">' + field.toUpperCase() + info + '</label><input style="width:auto;height:auto" type="checkbox" class="form-control" id="' + field + '" ' + value + '></div>';
                            } else
                                result += '<div class="form-group"><label for="' + field + '">' + field.toUpperCase() + info + '</label><input type="' + type + '" ' + required + ' class="form-control" id="' + field + '" value="' + value + '"' + disabled + '></div>';
                        }
                    }
                    $('#data').empty().data('id', tr.closest('table').data('id')).append(result).append('<hr><button class="btn btn-primary" id="update">Update</button> <button class="btn btn-default" id="delete">Delete</button>');
                });
            }
        });
        $('#rows').on('click', '#newRow', function () {
            var modelName = $(this).prev().data('id');
            var schema = schemas[modelName];
            var result = '';
            for (var field in schema) {
                if (field !== '__v' && field !== '_id') {
                    var info = ' - ' + schema[field].instance;
                    if (schema[field].instance == 'ObjectID' && schema[field].ref)
                        info = ' - ' + schema[field].ref + ' ObjectID';

                    if (schema[field].isRequired)
                        info += ', required';
                    required = 'required';
                    var required = schema[field].isRequired ? 'required' : '';
                    var defaultValue = '';
                    if (typeof schema[field].defaultValue != 'undefined')
                        defaultValue = schema[field].defaultValue;
                    var type = 'text';
                    if (schema[field].instance == 'Number')
                        type = 'number';
                    if (schema[field].instance == 'Boolean') {
                        defaultValue = defaultValue ? 'checked' : '';
                        result += '<div class="form-group"><label for="' + field + '">' + field.toUpperCase() + info + '</label><input style="width:auto;height:auto" type="checkbox" class="form-control" id="' + field + '" ' + defaultValue + '></div>';
                    } else
                        result += '<div class="form-group"><label for="' + field + '">' + field.toUpperCase() + info + '</label><input type="' + type + '" ' + required + ' class="form-control" id="' + field + '" value="' + defaultValue + '"></div>';
                }
            }
            $('#data').empty().data('id', modelName).append(result).append('<hr><button class="btn btn-primary" id="insert">Insert</button>');
        });
        function getData() {
            var modelName = $('#data').data('id');
            var schema = schemas[modelName];
            var data = {};
            $('#data input').each(function (index, input) {
                input = $(input);
                var value = input.val();
                var field = input.attr('id');
                var instance = schema[field].instance;
                if (instance == 'Boolean')
                    data[field] = input.prop('checked') ? true : false;
                else if (instance == 'Number' && value)
                    data[field] = Number(value);
                else if (instance == 'Date' && value)
                    data[field] = new Date(value);
                else if (instance == 'String')
                    data[field] = value;
                else if (instance == 'ObjectID' && value)
                    data[field] = value;
                else if (value)
                    alert('Unsupported field "' + instance + '" type on ' + field);
            });
            return data;
        }

        $('#data').submit(function (e) {
            return false;

        });
        $('#data').on('click', '#insert', function () {
            if ($('#data')[0].checkValidity()) {
                var modelName = $('#data').data('id');
                var data = getData();
                $.post('{{path}}/insert', {
                    modelName: modelName,
                    data: JSON.stringify(data)
                }).done(function (res) {
                    if (res != 'OK')
                        alert(JSON.stringify(JSON.parse(res), null, 2));
                    else
                        updateRows(modelName);
                });
            }
        });

        $('#data').on('click', '#update', function () {
            if ($('#data')[0].checkValidity()) {
                var modelName = $('#data').data('id');
                var data = getData();
                $.post('{{path}}/update', {
                    modelName: modelName,
                    data: JSON.stringify(data)
                }).done(function (res) {
                    if (res != 'OK')
                        alert(JSON.stringify(JSON.parse(res), null, 2));
                    else
                        updateRows(modelName);
                });
            }
        });
        $('#data').on('click', '#delete', function () {
            if ($('#data')[0].checkValidity()) {
                var modelName = $('#data').data('id');
                var data = getData();
                $.post('{{path}}/delete', {
                    modelName: modelName,
                    data: JSON.stringify(data)
                }).done(function (res) {
                    if (res != 'OK')
                        alert(JSON.stringify(JSON.parse(res), null, 2));
                    else
                        updateRows(modelName);
                });
            }
        });
    });
</script>
{{js}}
</body>
</html>